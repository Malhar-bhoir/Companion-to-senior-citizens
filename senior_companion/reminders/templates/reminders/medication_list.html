{% extends 'base.html' %}

{% block title %}My Medications{% endblock %}

{% block content %}
<div class="content-container p-4 p-md-5">
    <h1 class="mb-4">My Medication Reminders</h1>
    <p class="lead text-muted">Add your medications and set daily reminder times. The system will check every minute and
        print a reminder to the server console.</p>

    <!-- This is where success/error messages will appear -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert {% if message.tags %}{% if 'error' in message.tags %}alert-danger{% else %}alert-success{% endif %}{% else %}alert-success{% endif %}"
        role="alert">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <hr class="my-4">

    <!-- 
    ==================================
    SECTION 1: Add a New Medication
    ==================================
    -->
    <div class="mb-5">
        <h3><i class="bi bi-plus-circle-fill me-2"></i>Add a New Medication</h3>
        <form method="POST" action="{% url 'medication_list' %}" class="p-4 bg-light border rounded-3">
            {% csrf_token %}
            <!-- This form is for adding a NEW medication -->
            <div class="row">
                <div class="col-md-5">
                    <label for="{{ medication_form.name.id_for_label }}" class="form-label">Medication Name</label>
                    {{ medication_form.name }}
                </div>
                <div class="col-md-5">
                    <label for="{{ medication_form.dosage.id_for_label }}" class="form-label">Dosage (optional)</label>
                    {{ medication_form.dosage }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Add</button>
                </div>
            </div>
        </form>
    </div>

    <!-- 
    ==================================
    SECTION 2: Your Medications
    ==================================
    -->
    <div>
        <h3><i class="bi bi-list-ul me-2"></i>Your Current Medications</h3>

        {% if medications %}
        <div class_="list-group">
            {% for med in medications %}
            <div class="list-group-item p-3">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ med.name }}</h5>
                    <!-- Delete Medication Button -->
                    <form method="POST" action="{% url 'delete_medication' med.id %}"
                        onsubmit="return confirm('Are you sure you want to delete this medication and all its reminders?');">
                        {% csrf_token %}
                        <button type="submit" class="btn-close" aria-label="Delete Medication"></button>
                    </form>
                </div>
                <p class="mb-1 text-muted">{{ med.dosage|default:"No dosage specified" }}</p>

                <hr class="my-3">

                <!-- Reminder Times List -->
                <h6 class="mb-2">Your Reminders:</h6>
                {% if med.reminders.all %}
                <ul class="list-group list-group-flush mb-3">
                    {% for reminder in med.reminders.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                        <strong>{{ reminder.reminder_time|time:"g:i A" }}</strong>
                        <!-- Delete Reminder Button -->
                        <form method="POST" action="{% url 'delete_reminder' reminder.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted small">No reminders set for this medication.</p>
                {% endif %}

                <!-- Add Reminder Form (for this specific medication) -->
                <form method="POST" action="{% url 'add_reminder' med.id %}" class="d-flex">
                    {% csrf_token %}
                    <label for="{{ reminder_form.reminder_time.id_for_label }}" class="visually-hidden">Time</label>
                    {{ reminder_form.reminder_time }}
                    <button type="submit" class="btn btn-sm btn-primary">Add Time</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">You have not added any medications yet.</p>
        {% endif %}
    </div>
</div>

<!-- Simple SVG Icons (for the headings) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="bi-plus-circle-fill" fill="currentColor" viewBox="0 0 16 16">
        <path
            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z" />
    </symbol>
    <symbol id="bi-list-ul" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd"
            d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" />
    </symbol>
</svg>

{% comment %}
This is a custom template filter to add a CSS class to a form field.
It's a bit of a hack, but it's the easiest way without a 3rd party library.
We'll add the filter logic to our base.html.
{% endcomment %}

{% endblock %}