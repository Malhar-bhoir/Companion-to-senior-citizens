{% extends 'base.html' %}

{% block title %}Memory Match Challenge{% endblock %}

{% block content %}
<div class="content-container p-4">
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-success">Memory Match</h1>
        <p class="lead text-muted">Find all the matching pairs to win!</p>
    </div>

    <!-- Game Controls & Stats -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm border-success">
                <div class="card-body d-flex justify-content-between align-items-center bg-light rounded">
                    <div class="fs-4">
                        <span class="me-4">Moves: <strong id="moves" class="text-secondary">0</strong></span>
                        <span>Matches: <strong id="matches" class="text-success">0 / 6</strong></span>
                    </div>
                    <button id="reset-btn" class="btn btn-outline-success btn-lg">
                        <i class="fas fa-redo me-2"></i> Restart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Board -->
    <div id="game-board" class="d-grid gap-3 mx-auto" style="max-width: 600px; grid-template-columns: repeat(4, 1fr);">
        <!-- Cards injected by JS -->
    </div>

    <!-- Hidden Form for Saving Score -->
    <form id="score-form" method="POST" action="{% url 'record_game_session' %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="game_name" value="Memory Card Match">
        <input type="hidden" name="score" id="input-score">
        <input type="hidden" name="outcome" value="win">
    </form>

</div>

<!-- Win Modal (Simple Bootstrap Modal) -->
<div class="modal fade" id="winModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-header border-0 justify-content-center">
                <h2 class="modal-title text-success fw-bold">ðŸŽ‰ You Won! ðŸŽ‰</h2>
            </div>
            <div class="modal-body">
                <p class="fs-4">Great focus! You completed the game in <span id="final-moves" class="fw-bold"></span> moves.</p>
                <p class="text-muted">Your progress is being saved...</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary btn-lg" onclick="location.reload()">Play Again</button>
                <a href="{% url 'game_list' %}" class="btn btn-secondary btn-lg">Back to Games</a>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Card Styles for Flip Effect */
    .memory-card {
        aspect-ratio: 1 / 1;
        cursor: pointer;
        perspective: 1000px;
    }
    .memory-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }
    .memory-card.flipped .memory-card-inner {
        transform: rotateY(180deg);
    }
    .memory-card-front, .memory-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .memory-card-back {
        background-color: #264653; /* Dark High Contrast Back */
        color: white;
    }
    .memory-card-front {
        background-color: white;
        border: 4px solid #3D6B4C;
        transform: rotateY(180deg);
    }
    .memory-card.matched {
        opacity: 0.5;
        pointer-events: none;
    }
</style>

<script>
    const symbols = ['ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š']; 
    let cards = [...symbols, ...symbols];
    let flippedCards = [];
    let matchedPairs = 0;
    let moves = 0;
    let lockBoard = false;

    const board = document.getElementById('game-board');
    const movesDisplay = document.getElementById('moves');
    const matchesDisplay = document.getElementById('matches');
    
    // CHANGE: Declare variable without initializing with 'new bootstrap.Modal' immediately
    let winModal;

    function initGame() {
        // CHANGE: Initialize modal inside initGame which runs on window.onload
        // This ensures bootstrap script is loaded before we try to use it.
        if (!winModal && typeof bootstrap !== 'undefined') {
            winModal = new bootstrap.Modal(document.getElementById('winModal'));
        }

        board.innerHTML = '';
        cards.sort(() => 0.5 - Math.random());
        matchedPairs = 0;
        moves = 0;
        movesDisplay.innerText = 0;
        matchesDisplay.innerText = '0 / 6';
        flippedCards = [];
        lockBoard = false;

        cards.forEach(symbol => {
            const card = document.createElement('div');
            card.classList.add('memory-card');
            card.innerHTML = `
                <div class="memory-card-inner">
                    <div class="memory-card-back"><i class="fas fa-question"></i></div>
                    <div class="memory-card-front">${symbol}</div>
                </div>
            `;
            card.addEventListener('click', () => flipCard(card, symbol));
            board.appendChild(card);
        });
    }

    function flipCard(card, symbol) {
        if (lockBoard || card.classList.contains('flipped') || card.classList.contains('matched')) return;

        card.classList.add('flipped');
        flippedCards.push({ card, symbol });

        if (flippedCards.length === 2) {
            moves++;
            movesDisplay.innerText = moves;
            checkForMatch();
        }
    }

    function checkForMatch() {
        lockBoard = true;
        const [first, second] = flippedCards;

        if (first.symbol === second.symbol) {
            first.card.classList.add('matched');
            second.card.classList.add('matched');
            matchedPairs++;
            matchesDisplay.innerText = `${matchedPairs} / 6`;
            flippedCards = [];
            lockBoard = false;

            if (matchedPairs === 6) {
                gameOver();
            }
        } else {
            setTimeout(() => {
                first.card.classList.remove('flipped');
                second.card.classList.remove('flipped');
                flippedCards = [];
                lockBoard = false;
            }, 1000);
        }
    }

    function gameOver() {
        document.getElementById('final-moves').innerText = moves;
        // Safely try to show modal
        if (winModal) {
            winModal.show();
        } else {
            // Fallback if bootstrap failed to load
            alert("ðŸŽ‰ You Won! ðŸŽ‰\nTotal Moves: " + moves);
        }
        
        // Send data to Django backend
        saveScore();
    }

    function saveScore() {
        const form = document.getElementById('score-form');
        document.getElementById('input-score').value = moves; // Lower moves is better
        
        // Submit via Fetch API to avoid page reload immediately
        const formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => {
            console.log("Score saved!");
        }).catch(err => console.error("Error saving score:", err));
    }

    document.getElementById('reset-btn').addEventListener('click', initGame);
    
    // Use window.onload to ensure all scripts (including bootstrap in base.html) are loaded
    window.onload = initGame;
</script>
{% endblock %}